(()=>{"use strict";class e{player;webView;constructor(e,t){this.player=t,this.webView=e}initListeners(){}}var t=document.querySelector(".trackinfo-listentime").cloneNode(!0),i=document.querySelector(".trackinfo-playtime").cloneNode(!0);class s extends e{initListeners(){}static setTrackInfo(e){$.ajax({url:"/music/api/tracksInfo",method:"get",dataType:"json",data:{ids:e},success:s=>{if(0==s.length)return void addToast("Ошибка открытия","",s.msg,Math.floor(1e3*Math.random()));s=s[0],$(".trackinfo-name").text(s.trackname),$(".trackinfo-addeddate").text(s.addedDate),$(".trackinfo-name").attr("song_id",e);let n=document.querySelector(".tracklist-list.listenlist");n.innerHTML="";for(let e of s.listenDates){let i=t.cloneNode(!0);i.innerHTML=e,n.appendChild(i)}let a=document.querySelector(".tracklist-list.playlist");a.innerHTML="";for(let e of s.playDates){let t=i.cloneNode(!0);t.childNodes[0].nodeValue=e.date,t.querySelector(".trackinfo-source").innerHTML=e.source,a.appendChild(t)}"url"in s&&$("#sourceURL").val(s.url);let l=document.querySelector(".yt-videos");null!=l&&(l.innerHTML="")}})}}var n=document.querySelector(".playlist-checkbox").cloneNode(!0);class a extends e{initListeners(){}static addSong(){$("#addSongModal").modal("toggle")}static saveSong(){let e=[];for(let t of document.querySelectorAll(".musicSourceCheckbox"))if(t.checked){let i=t.getAttribute("musicSource_id");e.push(i)}$.ajax({url:"/music/api/addSong",method:"post",dataType:"json",data:{artist:$("#artistField").val(),title:$("#titleField").val(),sources:e.join(";"),csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val()},success:e=>{"ok"!=e.status&&addToast("Ошибка добавления","",e.msg)}}),$("#addSongModal").modal("toggle")}static addToPlaylist(){let e=document.querySelectorAll(".playlist-checkbox"),t=[],i=e[0].getAttribute("song_id");for(let i of e)i.querySelector(".playlist-input-checkbox").checked&&t.push(i.getAttribute("playlist_id"));$.ajax({url:"/music/api/savePlaylist",method:"post",dataType:"json",data:{playlist_ids:t.join(";"),song_id:i,csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val()},success:()=>{$("#addToPlaylistModal").modal("toggle")}})}static setLikeButtonGroup(e,t,i){$(t).removeClass(),$(i).removeClass(),$(t).addClass("btn"),$(i).addClass("btn"),e.length>0&&e[0].liked?$(t).addClass("btn-primary"):$(t).addClass("btn-secondary"),e.length>0&&e[0].disliked?$(i).addClass("btn-primary"):$(i).addClass("btn-secondary"),$(t).off("click").on("click",(()=>{let i=!0;0!=e.length&&(e[0].liked?(i=!1,$(t).removeClass("btn-primary"),$(t).addClass("btn-secondary")):($(t).removeClass("btn-secondary"),$(t).addClass("btn-primary")),$.ajax({url:"/music/api/setReaction",method:"post",dataType:"json",data:{song_id:e[0].id,is_negative:!1,set:i,csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val()},success:()=>{e[0].liked=i}}))})),$(i).off("click").on("click",(()=>{let t=!0;0!=e.length&&(e[0].disliked?(t=!1,$(i).removeClass("btn-primary"),$(i).addClass("btn-secondary")):($(i).removeClass("btn-secondary"),$(i).addClass("btn-primary")),$.ajax({url:"/music/api/setReaction",method:"post",dataType:"json",data:{song_id:e[0].id,is_negative:!0,set:t,csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val()},success:()=>{e[0].disliked=t}}))}))}static loadAddToPlaylistModal(e){document.querySelector(".playlists-checkboxes").innerHTML="",$.ajax({url:"/music/api/tracksInfo",method:"get",data:{ids:e},dataType:"json",success:t=>{a.setLikeButtonGroup(t,"#like-playlist-btn","#dislike-playlist-btn"),$.ajax({url:"/music/api/getUserPlaylistNames",method:"get",dataType:"json",success:i=>{for(let s of i){let i=n.cloneNode(!0);i.setAttribute("song_id",e),i.querySelector(".playlistName").innerHTML=s.name,i.setAttribute("playlist_id",s.id),t[0].playlists.includes(s.id)?i.querySelector(".playlist-input-checkbox").checked=!0:i.querySelector(".playlist-input-checkbox").checked=!1,document.querySelector(".playlists-checkboxes").append(i)}}})}})}}class l{title;artist;url;constructor(e,t){this.title=e,this.artist=t}setUrl(e){return this.url=e,this}toHTML(){return document.createElement("dummy")}}class r extends l{id;constructor(e,t,i){super(e,t),this.id=i}static fromObject(e){return new r(e.title,e.artist,e.id)}toHTML(e=1){let t=document.querySelector("templates .track").cloneNode(!0);return t.setAttribute("song_id",this.id),t.querySelector(".num").innerHTML=e,t.querySelector(".list-play-btn").setAttribute("song_id",this.id),t.querySelectorAll(".music-text")[0].innerHTML=this.title,t.querySelectorAll(".music-text")[1].innerHTML=this.artist,t.querySelector(".trackmenu-dropdown").setAttribute("song_id",this.id),t}}function o(e,t,i,s){c(e,(e=>{document.querySelector(".appView").innerHTML=e,s.clearInfo(),i instanceof u?i.as_function():i(),window.history.pushState("","Project Music",t)}))}function c(e,t,i){null==i&&(i={}),$.ajax({url:`/music/views/${e}`,method:"get",dataType:"html",data:i,success:t})}class u{player;webView;constructor(e,t){this.player=t,this.webView=e}init(){}fetchQueue(){}clearInfo(){}as_function(){return this.init(),this.fetchQueue(),this.webView.setListenersOnSongList(this.player),this}}function d(e,t){return Math.floor(Math.random()*(t-e+1)+e)}class h{static onRender=()=>{};queueName;id;tracks;#e=-1;nextSong;element;snippetQueue=!1;initState=!1;onEnded=()=>{};onNext=()=>{};constructor(e,t,i){this.queueName=e,this.id=t,this.element=null==i?document.createElement("tbody"):null!=i?i:document.querySelector(".queue"),this.element.setAttribute("id",t),this.fill()}setPointer(e){this.#e=e,this.initState=!1}getPointer(){return this.#e}fill(){if(this.clear(),null!=this.element)for(let e of this.element.children){let t=e.querySelector(".text-primary").innerHTML.trim().replaceAll("&amp;","&"),i=e.querySelector(".text-secondary").innerHTML.trim().replaceAll("&amp;","&"),s=e.getAttribute("song_id"),n=new r(t,i,s);this.tracks.push(n)}}isNew(){return!this.initState}get(){this.initState=!0,-1==this.#e&&this.tracks.length>0&&this.onNext(this.tracks[this.#e+1]);let e=this.shadowGet();return this.nextSong=void 0,e}shadowGet(){return null!=this.nextSong?this.nextSong:-1==this.#e?this.tracks[0]:this.tracks[this.#e]}next(){this.#e+1==this.tracks.length&&this.onEnded(),this.#e=(this.#e+1)%this.tracks.length,this.onNext(this.shadowGet()),this.initState=!1}previous(){0==this.#e?this.#e=this.tracks.length-1:this.#e=(this.#e-1)%this.tracks.length,this.initState=!1}setById(e){let t=this.#e,i=0;for(let t of this.tracks){if(t.id==e){this.#e=i;break}i++}t!=this.#e&&(this.initState=!1)}shuffle(){let e=-1!=this.#e?this.tracks[this.#e]:void 0;null!=e&&this.tracks.splice(this.#e,1),this.tracks=function(e){let t,i=e.length;for(;i>0;)t=Math.floor(Math.random()*i),i--,[e[i],e[t]]=[e[t],e[i]];return e}(this.tracks),null!=e&&this.tracks.splice(0,0,e),this.render(),this.#e=0}render(e){let t=e;null==t&&(t=this.element);let i=1;t.innerHTML="";for(let e of this.tracks)t.appendChild(e.toHTML(i)),i++;h.onRender()}sub(e){return this.tracks=e.tracks,this.id=e.id,this.setPointer(e.getPointer()),this.nextSong=e.nextSong,this.initState=e.initState,this.element.setAttribute("id",e.id),this}clear(){this.tracks=[],this.initState=!1}}class m extends u{selectedSourceId=-1;init(){$("#source-select .dropdown-item").click((e=>{let t=e.target;this.selectedSourceId=parseInt(t.getAttribute("source_id")),o(`main?source_id=${this.selectedSourceId}`,`?source_id=${this.selectedSourceId}`,this.as_function.bind(this),this.webView)})),null!=document.querySelector("#source-select .dropdown-item.active")&&(document.querySelector("#dropdownMenuButton").innerHTML=document.querySelector(".dropdown-item.active").innerHTML)}fetchQueue(){this.player.availableQueue=new h("random",10*d(1e3,2e7)+this.selectedSourceId,document.querySelectorAll(".queue")[2])}}class p extends u{selectedSourceId=-1;init(){$(".dropdown-item").click((e=>{let t=e.target;this.selectedSourceId=parseInt(t.getAttribute("source_id"));let i=t.parentElement.parentElement;for(let e of i.children)e.children[0].classList.remove("active");t.classList.add("active"),document.querySelector("#dropdownMenuButton").innerHTML=t.innerHTML,this.webView.pageNum=1,c(`sourceTrackList?page=${this.webView.pageNum}&id=${this.selectedSourceId}`,(e=>{document.querySelector(".music-content").innerHTML=e,this.player.availableQueue=new h("source",10*this.selectedSourceId+this.webView.pageNum),this.webView.setListenersOnSongList(this.player)}))})),this.webView.scrollEndTrigger=()=>{this.webView.pageNum+=1,c(`sourceTrackList?page=${this.webView.pageNum}&id=${this.selectedSourceId}`,(e=>{document.querySelector(".music-content").innerHTML+=e,this.player.availableQueue=new h("source",10*this.selectedSourceId+this.webView.pageNum),this.webView.setListenersOnSongList(this.player)}))},$(".radio-play-btn").click((e=>{let t=document.querySelectorAll(".radio-play-btn"),i=new h("radio",1),s=[],n=0,a=0;for(let i of t){e.target.parentElement==i&&(a=n);let t=i.querySelector(".radio-name").innerHTML,r=i.getAttribute("stream_url");s.push(new l(t,"радио").setUrl(r)),n++}i.tracks=s,i.setPointer(a),this.player.loadQueue(i),this.player.play()}))}fetchQueue(){this.player.availableQueue=new h("empty_sources",10*d(1e3,2e7),document.querySelectorAll(".queue")[2])}clearInfo(){this.selectedSourceId=-1}}class y extends u{init(){$.ajax({url:"/music/api/getSettings",method:"get",dataType:"json",success:function(e){for(let t in e)"boolean"==typeof e[t]&&$(`[setting="${t}"]`).prop("checked",e[t]);$(".setting-check").change((e=>{let t={};t[e.target.getAttribute("setting")]=e.target.checked,t.csrfmiddlewaretoken=$('[name="csrfmiddlewaretoken"]').val(),$.ajax({url:"/music/api/updateSettings",method:"post",data:t,dataType:"json",success:()=>{}})}))}})}fetchQueue(){this.player.availableQueue=new h("settings",2,null)}}class g extends u{typingTimer;doneTypingInterval=300;init(){this.webView.pageNum=1;var e=e=>{c("searchMedia",(e=>{document.querySelector(".music-content").innerHTML=e,this.player.availableQueue=new h("search",900+this.webView.pageNum),$(".addNewSong").click((()=>{a.addSong()})),this.webView.setListenersOnSongList(this.player)}),{query:e.trim()})};$(".search-field").on("keyup",(t=>{clearTimeout(this.typingTimer),this.typingTimer=setTimeout(e,this.doneTypingInterval,t.target.value)})),$(".search-field").on("keydown",(()=>{clearTimeout(this.typingTimer)})),$(".addSong-btn").click((()=>{a.saveSong()}))}}class f extends u{playlists;checkboxExample;init(){null==f.checkboxExample&&(f.checkboxExample=document.querySelector(".playlist-checkbox").cloneNode(!0)),$.ajax({url:"/music/api/getPlaylists",method:"get",dataType:"json",success:e=>{this.playlists=e,document.querySelector(".playlist-list").innerHTML="";for(let e of this.playlists)document.querySelector(".playlist-list").innerHTML+=`\n                    <a href="#" class="list-group-item list-group-item-action playlist-item" playlist_id=${e.id}>${e.name}</a>`;$(".playlist-item").click((e=>{for(let e of document.querySelectorAll(".playlist-item"))e.classList.remove("active"),e.setAttribute("aria-current","false");let t=parseInt(e.target.getAttribute("playlist_id")),i=[];for(let e of this.playlists)e.id==t&&(i=e.songs);this.player.availableQueue=new h("playlist",2e3+t),this.player.availableQueue.tracks=i,$.ajax({url:"/music/views/trackList",method:"post",dataType:"html",data:{songs:JSON.stringify(i),csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val()},success:t=>{document.querySelector(".playlist-content").innerHTML=t,e.target.classList.add("active"),e.target.setAttribute("aria-current","true"),this.webView.setListenersOnSongList()}})})),document.querySelector(".playlist-item").click()}}),$(".createBtn").off("click"),$(".createBtn").click((()=>{$("#addPlaylistModal").modal("toggle")})),$(".removeBtn").off("click"),$(".removeBtn").click((()=>{let e=document.querySelector(".playlist-item.active");null!=e&&parseInt(e.getAttribute("playlist_id"))>2&&($(".delete-msg").text(`Вы уверены в удалении плейлиста ${e.innerHTML}?`),$("#removePlaylistModal").modal("toggle"))})),$(".createPlaylist-btn").off("click"),$(".createPlaylist-btn").click((()=>{this.createPlaylist()})),$(".removePlaylist-btn").off("click"),$(".removePlaylist-btn").click((()=>{this.removePlaylist()}))}createPlaylist(){$.ajax({url:"/music/api/createPlaylist",method:"post",dataType:"json",data:{name:document.querySelector("#nameField").value,csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val()},success:e=>{"error"==e.status&&"unique_required"==e.error_type&&addToast("Ошибка создания","","Такой плейлист уже существует")}}),$("#addPlaylistModal").modal("toggle"),window.location.reload()}removePlaylist(){let e=document.querySelector(".playlist-item.active");$.ajax({url:"/music/api/removePlaylist",method:"post",dataType:"json",data:{name:e.innerHTML,csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val()},success:()=>{}}),$("#removePlaylistModal").modal("toggle"),window.location.reload()}}class k extends u{init(){null==localStorage.getItem("labSettings")?(this.object={sources:[],popular:!1},localStorage.setItem("labSettings",JSON.stringify(object))):this.object=JSON.parse(localStorage.getItem("labSettings"));for(let e of this.object.sources)document.querySelector(`#s${e}`).checked=!0;document.querySelector("#popularCheck").checked=this.object.popular,$(".lab-play").click((()=>{this.webView.labEnabled?(this.webView.labEnabled=!1,this.player.setPause(!0)):this.sendRequest()})),$("#popularCheck").change((e=>{this.object.popular=e.target.checked,localStorage.setItem("labSettings",JSON.stringify(this.object))})),$(".sourceCheck").change((e=>{if(e.target.checked)this.object.sources.push(parseInt(e.target.getAttribute("id").slice(1)));else{const t=this.object.sources.indexOf(parseInt(e.target.getAttribute("id").slice(1)));t>-1&&this.object.sources.splice(t,1)}localStorage.setItem("labSettings",JSON.stringify(this.object))}))}sendRequest(e){let t=JSON.parse(localStorage.getItem("labSettings"));$.ajax({url:"/music/api/labRequest",method:"get",dataType:"json",success:e=>{this.webView.labEnabled=!0;let t=new h;t.tracks=[],t.onEnded=()=>{this.sendRequest(!1)},t.onNext=e=>{$(".lab-current-music").text("станет известно через несколько секунд"),setTimeout((()=>{$(".lab-current-music").text(e.shadowName)}),25e3)};for(let i of e){let e=new r("Песня","Лаборатория музыки",i.id);e.shadowName=i.shadowName,t.tracks.push(e)}this.player.loadQueue(t),this.player.play()},data:{popular:t.popular,sources:t.sources.join(";")},async:null==e||e,error:()=>{}})}}var S=document.querySelector(".yt-video").cloneNode(!0);class b extends e{initListeners(){$(".yt-search-btn").click((()=>{let e=document.querySelector(".trackinfo-name").innerHTML;$.ajax({url:"/music/api/ytSearch",method:"get",dataType:"json",data:{q:e},success:e=>{b.viewYtSearch(e)}})}))}static viewYtSearch(e){let t=document.querySelector(".yt-videos"),i=document.querySelector("#sourceURL").value.split("=")[1];t.style.visibility="visible";for(let s of e){let e=S.cloneNode(!0);e.setAttribute("video_id",s.id),s.id!=i&&e.classList.remove("active"),e.querySelector(".yt-video-name").innerHTML=s.name,e.querySelector(".yt-video-channel").innerHTML=s.channel,e.querySelector(".yt-video-date").innerHTML=s.date,e.addEventListener("click",(e=>{for(let e of document.querySelector(".yt-videos").childNodes)e.classList.contains("active")&&e.classList.remove("active");e.currentTarget.classList.add("active"),$("#sourceURL").val("https://youtube.com/watch?v="+e.currentTarget.getAttribute("video_id"))})),t.appendChild(e)}}}let v=new Map;function w(e){let t=$("#lyricsPrompt").val();if(v.has(t))return v.get(t);""!=t.trim()&&$.ajax({url:"/music/api/getLyrics",method:"get",dataType:"json",data:{q:t},success:e=>{if("ok"!=e.status)return void addToast("Ошибка","",e.msg);v.set(t,e);let i=document.querySelector(".lyrics-section");i.querySelector(".songName").innerHTML=`${e.artist} - ${e.title}`,i.querySelector(".release-date").innerHTML=e.release_date,i.querySelector(".lyrics-text").innerText=e.lyrics},error:()=>{addToast("Ошибка","","Сервис недоступен")}})}var q=()=>{};let L=new class{queue;availableQueue;#t=void 0;#i=[];#s=null;#n=!1;#a=!0;#l=void 0;snippetMode=!1;#r=void 0;onQueueChanged=()=>{};onMediaPlayed=e=>{};constructor(){this.queue=new h("empty",0),$(".volume-slider").val(null==localStorage.getItem("volume")?100:parseInt(localStorage.getItem("volume")));let e=document.querySelector(".video-view");null!=e?(this.#t=e,this.#t.addEventListener("click",(e=>{2==e.detail&&this.setPause(!this.isPaused())}))):(this.#t=new Audio,this.#t.autoplay=!0,this.#a=!1),this.#t.pause(),this.#t.volume=$(".volume-slider").val()/100}initListeners(e){$(".volume-slider").on("input",(e=>{this.#t.volume=$(e.target).val()/100,localStorage.setItem("volume",$(e.target).val())})),$(".play-button").click((e=>{this.play()})),$(".previous-button").click((e=>{this.previous()})),$(".next-button").click((e=>{this.next()})),$(".pip-button").click((e=>{this.#t.requestPictureInPicture()})),$(".fullscreen-button").click((e=>{this.#t.requestFullscreen()})),$(".popup-info-button").click((e=>{$("#infoModal").modal("toggle")})),e.onPlayButtonInList=e=>{this.checkQueue(e);let t=e.currentTarget.getAttribute("song_id");this.queue.setById(t),this.queue.snippetQueue=this.snippetMode,this.play(),this.snippetMode=!1},q=()=>{$(".timeline-slider").val(Math.floor(this.#t.currentTime)),$(".timeline-slider").attr("value",Math.floor(this.#t.currentTime)),this.#s=requestAnimationFrame(q)},$(".timeline-slider").on("input",(()=>{this.calculateTime(),this.#t.paused||cancelAnimationFrame(this.#s)})),$(".timeline-slider").on("change",(e=>{this.#t.currentTime=e.target.value,this.#t.paused||requestAnimationFrame(q)})),this.#t.addEventListener("loadedmetadata",(()=>{if(this.calculateTime(),$(".timeline-slider").attr("max",Math.floor(this.#t.duration)),this.queue.snippetQueue)for(let e of this.calculateSnippetSize(this.#t.duration))this.#i.push(e)})),this.#t.addEventListener("timeupdate",(()=>{for(let e of this.#i)this.#t.currentTime>=e[0]&&this.#t.currentTime<e[1]&&(this.#t.currentTime=e[1]);this.calculateTime()})),this.#t.addEventListener("ended",(()=>{this.#t.src="",this.next()})),navigator.mediaSession.setActionHandler("play",(()=>{this.play()})),navigator.mediaSession.setActionHandler("pause",(()=>{this.play()})),navigator.mediaSession.setActionHandler("previoustrack",(()=>{this.previous()})),navigator.mediaSession.setActionHandler("nexttrack",(()=>{this.next()})),this.#t.addEventListener("pause",(()=>{this.changeIconState()})),this.#t.addEventListener("play",(()=>{this.changeIconState()})),e.setListenersOnSongList()}enterSnippetMode(){this.snippetMode=!0}calculateSnippetSize(e){let t=0;this.#i.length>0&&this.#i[0][0]<5&&(t=this.#i[0][1]);let i=d(t,Math.floor(e/1.5)+t);return[[0,i],[i+30+1,e]]}getPairedListButtonList(){let e=this.queue.shadowGet();if(null!=e){let t=e.id;return document.querySelectorAll(`button[song_id="${t}"]`)}}checkQueue(e){if("empty"==this.queue.name&&null!=this.availableQueue&&this.loadQueue(this.availableQueue),null!=e){let t=e.currentTarget.parentElement.parentElement.parentElement;if(parseInt(t.getAttribute("id"))==this.availableQueue.id)this.loadQueue(this.availableQueue);else{let i=parseInt(t.getAttribute("id"));null==i&&(i=d(1001,1e6));let s=new h("custom",i,t);s.setById(parseInt(e.currentTarget.getAttribute("song_id"))),this.loadQueue(s)}}}changeIconState(){let e=this.getPairedListButtonList();if(this.#r!=e&&null!=this.#r)for(let e of this.#r)e.innerHTML='<i class="ri-play-fill"></i>';if(this.#r=e,this.#t.paused){if($(".play-button").html('<i class="ri-play-fill"></i>'),null!=e)for(let t of e)t.innerHTML='<i class="ri-play-fill"></i>'}else{$(".play-button").html('<i class="ri-pause-fill"></i>');for(let t of e)t.innerHTML='<i class="ri-pause-fill"></i>'}}calculateTime(){let e=Math.floor(this.#t.currentTime/60),t=Math.floor(this.#t.currentTime)%60,i=Math.floor(this.#t.duration/60),s=Math.floor(this.#t.duration)%60;i=Number.isFinite(i)?i:0,s=Number.isFinite(s)?s:0,e=Number.isFinite(e)?e:0,t=Number.isFinite(t)?t:0,e=e<10?`0${e}`:`${e}`,t=t<10?`0${t}`:`${t}`,i=i<10?`0${i}`:`${i}`,s=s<10?`0${s}`:`${s}`;let n=`${e}:${t}`,a=`${i}:${s}`,l=`${n}/${a}`;$(".time-info").text(l),$(".start-time").text(n),$(".end-time").text(a)}loadQueue(e){this.queue=e,this.onQueueChanged(),this.changeIconState()}isPaused(){return this.#t.paused}play(e){if(this.checkQueue(),this.queue.isNew()){let t;null!=this.#l&&this.#l.abort(),t=null!=e?e:this.queue.get(),$(".title-info").text(t.title),$(".artist-info").text(t.artist),this.queue.snippetQueue?($(".status-info").text("сниппет"),$(".status-info").css({display:"inline"})):$(".status-info").css({display:"none"}),navigator.mediaSession.metadata=new MediaMetadata({title:t.title,artist:t.artist}),this.requestSongInfo(t,(e=>{a.setLikeButtonGroup(e,"#like-button","#dislike-button")})),null!=t.url?(this.#t.src=t.url,this.setPause(!1)):(this.setPause(!0),this.#n=!0,this.requestSource(t,this.#a,(e=>{if(this.#i=[],this.#n=!1,"ok"==e.status){if(!this.queue.snippetQueue)for(let t of e.skips)this.#i.push(t);this.#t.src=e.url,t.setUrl(e.url),this.setPause(!1)}else addToast("Ошибка","",e.msg),this.next();this.#l=void 0}),(()=>{this.#n=!1,this.#l=void 0})))}else{if(this.#n)return;this.setPause(!this.#t.paused)}}requestSongInfo(e,t,i){$.ajax({url:"/music/api/tracksInfo",method:"get",dataType:"json",data:{ids:e.id},success:t,error:i})}setPause(e){this.#t.paused!=e&&(e?(cancelAnimationFrame(this.#s),this.#t.pause()):(requestAnimationFrame(q),this.#t.play(),this.onMediaPlayed(this.queue.shadowGet())))}next(){this.checkQueue(),this.queue.next(),this.play()}previous(){this.checkQueue(),this.queue.previous(),this.play()}requestSource(e,t,i){e.isVideo=t,this.#l=$.ajax({url:"/music/api/getMedia",method:"get",data:e,dataType:"json",success:i})}},T=new class{pageNum=-1;scrollEndTrigger=()=>{};onPlayButtonInList=()=>{};player;savedQueue;constructor(e){this.player=e}clearInfo(){this.pageNum=-1,this.scrollEndTrigger=void 0,this.setListenersOnSongList(this.player)}setListenersOnSongList(e){$(".list-play-btn").off("click"),$(".list-play-btn").click(this.onPlayButtonInList),$(".text-primary.music-text").off("click"),$(".text-primary.music-text").click((e=>{s.setTrackInfo(e.target.parentElement.parentElement.getAttribute("song_id")),$("#trackInfoModal").modal("toggle")})),$(".track-action").off("click"),$(".track-action").click((e=>{let t=e.currentTarget.parentElement.parentElement.parentElement.getAttribute("song_id"),i=e.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement,s=e.currentTarget.getAttribute("action"),n=new r(i.querySelectorAll(".music-text")[0].innerHTML,i.querySelectorAll(".music-text")[1].innerHTML,t);"playNext"==s?this.player.queue.nextSong=n:"addToPlaylist"==s?($("#addToPlaylistModal").modal("toggle"),a.loadAddToPlaylistModal(t)):"addToSavedQueue"==s?null!=this.savedQueue&&(this.savedQueue.containsSongId(t)?(this.savedQueue.remove(this.savedQueue.findSong(t)),addToast("Успешно","только что","Песня удалена из списка отложенных")):(this.savedQueue.add(n),addToast("Успешно","только что","Песня добавлена в список отложенных"))):"snippet"==s&&(this.player.enterSnippetMode(),$(`button[song_id=${t}]`).trigger("click"))}))}}(L);h.onRender=()=>{T.setListenersOnSongList(L)},L.initListeners(T);let x=new h("current",9,document.querySelector(".queue-current")),M=new class extends h{constructor(){if(super("local",10,document.querySelector(".queue-saved")),null!=localStorage.getItem("saved")){this.tracks=JSON.parse(localStorage.getItem("saved"));for(let e=0;e<this.tracks.length;e++)this.tracks[e]=r.fromObject(this.tracks[e])}else this.tracks=[];this.render()}dump(){let e=[];for(let t of this.tracks)e.push({title:t.title,artist:t.artist,id:t.id});localStorage.setItem("saved",JSON.stringify(e))}add(e){this.tracks.push(e),this.dump(),this.render()}findSong(e){e=parseInt(e);for(let t=0;t<this.tracks.length;t++)if(this.tracks[t].id==e)return this.tracks[t]}containsSongId(e){return null!=this.findSong(e)}remove(e){let t;for(t=0;t<this.tracks.length&&this.tracks[t].id!=e.id;t++);t!=this.tracks.length&&null!=t&&this.tracks.splice(t,1),this.dump(),this.render()}shuffle(){super.shuffle(),this.dump()}get(){let e=super.get();return this.remove(e),this.setPointer(this.getPointer()-2),this.initState=!0,e}};T.savedQueue=M,L.onQueueChanged=()=>{10==L.queue.id&&(L.queue=M),x.sub(L.queue).render()},$(".main-link").click((()=>{o("main","/music",new m(T,L),T)})),$(".sources-link").click((()=>{o("sources","/music/sources",new p(T,L),T)})),$(".settings-link").click((()=>{o("settings","/music/settings",new y(T,L),T)})),$(".search-link").click((()=>{o("search","/music/search",new g(T,L),T)})),$(".saved-link").click((()=>{o("playlists","/music/playlists",new f(T,L),T)})),$(".lab-link").click((()=>{o("lab","/music/lab",new k(T,L),T)})),window.onscroll=function(){window.innerHeight+window.scrollY+5>=document.body.offsetHeight&&(console.log("End reached"),null!=T.scrollEndTrigger&&T.scrollEndTrigger())};let I=window.location.href.split("/"),P=I[I.length-1];P.startsWith("sources")?new p(T,L).as_function():P.startsWith("settings")?new y(T,L).as_function():P.startsWith("search")?new g(T,L).as_function():P.startsWith("playlists")?new f(T,L).as_function():P.startsWith("lab")?new k(T,L).as_function():new m(T,L).as_function(),function(e,t){const i=[new s(e,t),new a(e,t),new b(e,t)];for(let e of i)e.initListeners();!function(e){e.onMediaPlayed=e=>{document.querySelector(".video-view-modal").classList.contains("modal-lg")&&($("#lyricsPrompt").val(`${e.artist} - ${e.title}`),document.querySelector(".lyrics-prompt-btn").click())},$(".lyrics-button").click((()=>{let t=document.querySelector(".video-view-modal");if(t.classList.contains("modal-lg")){t.classList.remove("modal-lg"),t.classList.add("modal-xl");let i=t.querySelector(".view-section");i.classList.remove("col-12"),i.classList.add("col-8"),t.querySelector(".lyrics-section").classList.add("col-4"),t.querySelector(".lyrics-section").style="";let s=e.queue.shadowGet();null==s?$("#lyricsPrompt").val(""):$("#lyricsPrompt").val(`${s.artist} - ${s.title}`),$(".lyrics-section").css("height",$(".video-view").height()),w()}else{t.classList.remove("modal-xl"),t.classList.add("modal-lg");let e=t.querySelector(".view-section");e.classList.remove("col-8"),e.classList.add("col-12"),t.querySelector(".lyrics-section").classList.remove("col-4"),t.querySelector(".lyrics-section").style="display: none"}})),$(".lyrics-prompt-btn").click((()=>{w()}))}(t)}(T,L),$(".addToPlaylistBtn").click((()=>{a.addToPlaylist()})),$(".queueBtn").click((()=>{const e=document.getElementById("sidebar");e.classList.contains("opened-sidebar")?e.classList.remove("opened-sidebar"):e.classList.add("opened-sidebar")})),$(".shuffleBtn").click((()=>{document.querySelector("#current-tab").classList.contains("active")?(x.setPointer(L.queue.getPointer()),x.initState=L.queue.initState,x.shuffle(),L.queue.sub(x).render()):M.shuffle()})),document.addEventListener("keydown",(e=>{"Space"==e.code&&$(".modal.in").length>0&&L.setPause(!L.isPaused())}))})();